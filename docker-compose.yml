# Vulcan Production Docker Compose
# Usage: docker compose up -d
#
# Prerequisites:
#   1. Run: vulcan setup production (or ./setup-docker-secrets.sh)
#   2. This creates .env with secure secrets
#
# First time setup:
#   docker compose up -d
#   docker compose exec web bin/rails db:prepare
#
# Maintenance:
#   docker compose logs -f        # View logs
#   docker compose exec web bash  # Shell access
#   docker compose down           # Stop services

services:
  db:
    image: postgres:16-alpine
    restart: unless-stopped
    volumes:
      - vulcan_dbdata:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-vulcan_postgres_production}
    expose:
      - "${DATABASE_PORT:-5432}"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 30s
      timeout: 10s
      retries: 5

  web:
    image: ${VULCAN_IMAGE:-mitre/vulcan}:${VULCAN_VERSION:-latest}
    build:
      context: .
      dockerfile: Dockerfile
      target: production
      args:
        WEB_PORT: ${PORT:-3000}
        PROMETHEUS_PORT: ${PROMETHEUS_PORT:-9394}
    restart: unless-stopped
    ports:
      - "${PORT:-3000}:${PORT:-3000}"
      - "${PROMETHEUS_PORT:-9394}:${PROMETHEUS_PORT:-9394}"
    environment:
      # 12-Factor: PORT and HOST are primitives, URLs derived at runtime
      PORT: ${PORT:-3000}
      HOST: ${HOST:-localhost}
      VULCAN_SCHEME: ${VULCAN_SCHEME:-http}
      DATABASE_URL: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@db:${DATABASE_PORT:-5432}/${POSTGRES_DB:-vulcan_postgres_production}
      RAILS_ENV: production
      RAILS_SERVE_STATIC_FILES: "true"
      RAILS_LOG_TO_STDOUT: "true"
      # jemalloc for memory efficiency
      LD_PRELOAD: /usr/local/lib/libjemalloc.so
      MALLOC_ARENA_MAX: "2"
    env_file:
      - .env
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:${PORT:-3000}/up || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    volumes:
      - vulcan_storage:/rails/storage
      - ./log:/rails/log

volumes:
  vulcan_dbdata:
  vulcan_storage:
