#!/usr/bin/env ruby
require "fileutils"

APP_ROOT = File.expand_path("..", __dir__)

def system!(*args)
  system(*args, exception: true)
end

FileUtils.chdir APP_ROOT do
  puts "\n== Vulcan Development Setup =="
  puts "This script will set up everything you need to run Vulcan locally.\n\n"

  # Check for Docker
  unless system("docker info > /dev/null 2>&1")
    puts "❌ Docker is not running. Please start Docker and try again."
    exit 1
  end

  # Copy .env.example to .env if it doesn't exist
  unless File.exist?(".env")
    puts "== Creating .env from .env.example =="
    FileUtils.cp ".env.example", ".env"
    puts "   Created .env - edit this file to customize your configuration"
  end

  # Start PostgreSQL with Docker
  puts "\n== Starting PostgreSQL with Docker =="
  if system("docker-compose -f docker-compose.dev.yml ps --services --filter status=running 2>/dev/null | grep -q db")
    puts "   PostgreSQL already running"
  else
    system! "docker-compose -f docker-compose.dev.yml up -d"
    puts "   Waiting for PostgreSQL to be ready..."
    sleep 3
  end

  # Install Ruby dependencies
  puts "\n== Installing Ruby dependencies =="
  system("bundle check") || system!("bundle install")

  # Install JavaScript dependencies
  puts "\n== Installing JavaScript dependencies =="
  system! "pnpm install"

  # Build frontend assets
  puts "\n== Building frontend assets =="
  system! "pnpm build"

  # Setup database
  puts "\n== Preparing database =="
  system! "bin/rails db:prepare"

  # Cleanup
  puts "\n== Removing old logs and tempfiles =="
  system! "bin/rails log:clear tmp:clear"

  puts "\n✅ Setup complete!"
  puts "\nDefault login: admin@example.com / 1234567ab!"
  puts "Configuration: .env (edit to customize)"

  unless ARGV.include?("--skip-server")
    puts "\n== Starting development server =="
    puts "   Access Vulcan at http://localhost:3000\n\n"
    STDOUT.flush
    exec "foreman start -f Procfile.dev"
  end
end
